#!/usr/bin/env bash

#------------------------------------------------------------------------------#
# Defining usage and setting inputs
#------------------------------------------------------------------------------#
usage() {
        echo "
        This script runs colabfold locally using the colabfold_batch command. 
        You must have colabfold installed! It is highly recommended that the
        input to this file is an a3m alignment generated by mmseqs2, althuogh 
        you may also input a fasta containing a single sequence. If a fasta is
        input, colabfold will query the mmseqs online server for alignment. This
        script uses gpu unless the -u switch is specified.

        Required params:
        -i --INFILE {a3m or fasta}
            Input a3m alignment file or fasta file containing a single sequence.
            Note that the file MUST end in .a3m or .fasta so that colabfold
            knows the input file type.
        -d --OUT_DIR {path}
            The name of the output directory. This will contain many output
            files including multiple structural models, png's of plddt, a copy
            of the a3m input file, etc. Notably, the best pdb model will match
            the pattern *rank_1*.pdb, but all models will be present.

        Optional params:
        -o --OUTFILE {pdb}
            If specified, will create a copy of the best-model pdb file (e.g.
            the file that matches the path OUT_DIR/*rank_1*.pdb) at the
            specified path.
        -n --NUM_RECYCLES {int} [DEFAULT: 3]
            Number of recycles for colabfold when generating structures.
        -u --USE_CPU
            Boolean switch.
            If specified, will add the --cpu flag and run via cpu. Not
            recomended, as it will take ages to run.
        -a --USER_AMBER
            Boolean switch.
            If specified, will use the --amber switch for structure relaxation.
            This isn't the default because it can fail sometimes (probably
            dependent on resources).
        "
}

#If less than 2 options are input, show usage and exit script.
if [ $# -le 3 ] ; then
        usage
        exit 1
fi

# Boolean flag defaults
USE_CPU=false
USER_AMBER=false

#Setting input
while getopts i:d:o:n:ua option ; do
        case "${option}"
        in
                i) INFILE=${OPTARG};;
                d) OUT_DIR=${OPTARG};;
                o) OUTFILE=${OPTARG};;
                n) NUM_RECYCLES=${OPTARG};;
                u) USE_CPU=true;;
                a) USER_AMBER=true;;
        esac
done

#------------------------------------------------------------------------------#
# Set defaults and constants
#------------------------------------------------------------------------------#
# Defaults
NUM_RECYCLES=${NUM_RECYCLES:-3}
OUTFILE=${OUTFILE:-""}

if $USER_AMBER ; then
    AMBER_SETTING="--amber"
else
    AMBER_SETTING=""
fi


#------------------------------------------------------------------------------#
# Validate inputs and program availablity
#------------------------------------------------------------------------------#

# Make sure input file ends in .a3m or .fasta. If it's a fasta, make sure it
# only has one sequence
if [[ $INFILE == *.a3m ]] ; then
    :
elif [[ $INFILE == "*.fasta" ]] ; then
    if (( $(grep -c "^>" $INFILE) > 1 )) ; then 
        echo "Input fasta file must contain only one sequence."
        echo "(grep -c "^>" $INFILE) sequences are detected."
        exit 1 
    fi
else 
    echo "Input file does not end in .a3m or .fasta!!"
    exit 1
fi

# Make sure all input files exist
if [ ! -f $INFILE ] ; then
    echo "Input file, $INFILE, not detected."
    exit 1
fi

# Make sure required programs are available
if ! command -v colabfold_batch ; then
    echo "colabfold_batch not detected!"
    exit 1
fi


#------------------------------------------------------------------------------#
# Main
#------------------------------------------------------------------------------#
echo "
$0 inputs:

INFILE: $INFILE
OUT_DIR: $OUT_DIR
OUTFILE: $OUTFILE
NUM_RECYCLES: $NUM_RECYCLES
USE_CPU: $USE_CPU
USER_AMBER: $USER_AMBER
"

echo "$0: Started at $(date)"

# Make output directory if necessary
mkdir -p $OUT_DIR

# Run colabfold
colabfold_batch \
    --templates \
    --num-recycle $NUM_RECYCLES \
    --use-gpu-relax \
    $AMBER_SETTING \
    $INFILE \
    $OUT_DIR

# If OUTFILE is specified, copy the best model to the outfile
if [[ $OUTFILE != "" ]] ; then
    cp ${OUT_DIR/*rank_1*.pdb} $OUTFILE
fi


echo "ended at $(date)"